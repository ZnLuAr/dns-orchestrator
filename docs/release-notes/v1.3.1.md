# v1.3.1 发行说明

## 概述

v1.3.1 是一个性能优化和代码质量改进版本，主要聚焦于内存缓存优化、错误处理增强和代码结构重构。此版本显著提升了应用启动速度和运行时性能。

## 性能优化

### 内存缓存改进

- **账户仓库缓存优化**：将缓存类型从 `Option<Vec<Account>>` 改为 `Option<Arc<Vec<Account>>>`，避免不必要的克隆操作
- **凭证存储缓存**：为 `TauriCredentialStore` 添加内存缓存层，减少系统 Keychain 调用频率
- **HTTP 客户端共享**：将 HTTP Client 改为全局共享单例（`OnceLock`），复用连接池，减少资源开销

### 启动性能提升

- **异步账户恢复**：将账户恢复流程改为后台异步执行，不再阻塞应用启动
- **恢复状态轮询**：新增 `is_restore_completed` 命令和前端轮询机制，实时展示恢复进度

### 前端组件优化

- 使用 `useShallow` 优化 Zustand store 订阅粒度
- 对 `DnsRecordCard` 和 `DnsRecordRow` 组件添加 `memo` 包装
- 使用 `useCallback` 和 `useMemo` 避免不必要的重渲染

## 代码重构

### 服务层架构

- **ImportExportService 分离**：将账户导入导出功能从 `AccountService` 提取为独立服务
- **ServiceContext 增强**：将 `get_provider` 和 `mark_account_invalid` 方法提取到上下文，供多个服务复用
- **ToolboxService 无状态化**：重构为静态方法，移除不必要的实例化

### 错误处理增强

- **凭证失效自动检测**：DNS 服务和域名服务在 API 调用失败时自动检测凭证失效，将账户标记为错误状态
- **错误日志记录**：将所有 `let _ = ...` 模式改为 `if let Err(e) = ...` 并记录警告日志，提高可观测性
- **ErrorContext 传递**：为所有 DNS 提供商的 HTTP 请求添加上下文参数，错误信息包含域名、记录 ID 等

### 代码结构优化

- **DnsRecordTable 组件拆分**：分离为 `DesktopTable` 和 `MobileCardList` 独立组件
- **公共函数提取**：`relative_to_full_name` 等函数移到公共模块供多个 Provider 共享
- **解密逻辑复用**：提取 `parse_and_decrypt_accounts` 方法，消除导入导出中的重复代码

## Bug 修复

### DNSPod 状态判断

- 新增 `dns_status` 字段支持，当 `status` 为 ENABLE 但 `dns_status` 为 DNSERROR 时正确返回错误状态

### 前端问题修复

- 修复 `HomePage` 中 `recentDomains` 状态初始化问题
- 修复 `RootLayout` 中账户清理逻辑，避免空数组误清理
- 移除 `DomainSelectorPage` 中默认展开第一个账户的逻辑

## 其他改进

### get_domain 方法优化

各 DNS 提供商的 `get_domain` 方法改用专用 API，提升性能和准确性：
- **阿里云**：使用 `DescribeDomainInfo` API
- **DNSPod**：使用 `DescribeDomain` API
- **华为云**：使用 `ShowPublicZone` API

### 开发工作流

- 将 `format:rust` 和 `lint:rust` 拆分为针对不同子项目的独立命令
- 新增 `postinstall` 脚本用于版本同步

## 升级说明

从 v1.3.0 升级无需额外操作，直接安装新版本即可。
