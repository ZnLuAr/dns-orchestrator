# v1.5.0 发行说明

## 概述

v1.5.0 是一个重大重构版本，将 DNS 记录从扁平的字符串表示重构为类型安全的结构化数据。这一改动提升了代码可维护性、类型安全性，并为复杂记录类型（MX、SRV、CAA）提供了更好的表单编辑体验。

## 重大变更

### DNS 记录数据结构重构

**之前**：

```typescript
interface DnsRecord {
  type: DnsRecordType
  value: string        // 所有类型共用一个字符串字段
  priority?: number    // MX/SRV 专用，但挂在顶层
}
```

**之后**：

```typescript
interface DnsRecord {
  data: RecordData     // 类型安全的多态数据
}

type RecordData =
  | { type: "A"; content: { address: string } }
  | { type: "AAAA"; content: { address: string } }
  | { type: "CNAME"; content: { target: string } }
  | { type: "MX"; content: { priority: number; exchange: string } }
  | { type: "TXT"; content: { text: string } }
  | { type: "NS"; content: { nameserver: string } }
  | { type: "SRV"; content: { priority: number; weight: number; port: number; target: string } }
  | { type: "CAA"; content: { flags: number; tag: string; value: string } }
```

**改进收益**：

- 类型安全：编译时检查记录类型与字段匹配
- 语义清晰：`address`、`target`、`exchange` 等字段名比通用 `value` 更具可读性
- 扩展性：添加新记录类型无需修改现有代码
- 前后端一致：Rust 和 TypeScript 使用相同的 tagged union 结构

## 新功能

### 结构化表单编辑

针对复杂记录类型提供独立输入字段：

- **MX 记录**：分离的优先级和邮件服务器输入框
- **SRV 记录**：优先级、权重、端口、目标四个独立字段
- **CAA 记录**：标志位、标签（issue/issuewild/iodef）、值三个独立字段

### 新增错误类型

新增 `UnsupportedRecordType` 错误，当 Provider 不支持某种记录类型时返回明确的错误信息。

## 改进

### Provider 层适配

四个 DNS Provider 均完成适配：

- **Cloudflare**：重构 HTTP 层，简化 API 请求/响应映射
- **阿里云 DNS**：适配新数据结构，保持 API 兼容
- **腾讯云 DNSPod**：适配新数据结构，保持 API 兼容
- **华为云 DNS**：重构 HTTP 层，优化代码结构

### 前端组件更新

- `DnsRecordForm`：根据记录类型动态渲染对应字段
- `DnsRecordRow`/`DnsRecordCard`：适配新数据结构展示
- `useDnsTableSort`：适配新结构的排序逻辑

### 国际化

新增 MX/SRV/CAA 相关字段的中英文翻译。

## 技术统计

- **修改文件**：19 个
- **新增代码**：+1,442 行
- **删除代码**：-502 行
- **净增加**：+940 行

**主要变更分布**：

- Provider 层重构：~800 行
- 前端表单重构：~400 行
- 类型定义：~120 行

## 破坏性变更

**API 变更**：

- `DnsRecord.type` → `DnsRecord.data.type`
- `DnsRecord.value` → `DnsRecord.data.content.*`（字段名因记录类型而异）
- `DnsRecord.priority` → `DnsRecord.data.content.priority`（仅 MX/SRV）
- `CreateDnsRecordRequest` 和 `UpdateDnsRecordRequest` 同样变更

**迁移说明**：

数据库存储格式保持兼容，升级后首次加载会自动适配新结构。无需手动迁移数据。

## 升级说明

从 v1.4.2 升级无需额外操作，直接安装新版本即可。

**注意事项**：

- 如有自定义脚本调用 DNS 记录 API，需按新结构调整
- 建议升级前备份配置数据
