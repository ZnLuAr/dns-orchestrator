# v1.9.0 发行说明

## 概述

v1.9.0 是一次重大的架构现代化版本。本版本将整个项目重构为标准 Cargo Workspace，统一依赖管理和构建流程；将工具箱功能拆分为独立 crate，实现真正的模块化架构；移除 Actix-Web 后端，聚焦 Tauri 桌面/移动端体验。同时引入 CI/CD 流水线、Android APK 签名验证、大规模测试覆盖和代码质量提升，为项目的长期可维护性奠定坚实基础。

## 新增功能

### 🔒 Android 更新签名验证

为 Android 平台引入基于 minisign 的 APK 签名验证机制，确保更新包的完整性和可信性：

**安全机制**：
- 下载 APK 后使用 minisign 验证签名（公钥编译时嵌入）
- 签名验证失败自动删除不可信 APK 文件
- 安装路径白名单检查（仅允许缓存目录）
- 签名字段不存在或为 "none" 时拒绝更新

**更新流程**：
- 从 GitHub Releases 获取 `latest.json` 检查更新
- 流式下载 APK 并实时显示进度
- 下载完成后验证 minisign 签名
- 使用 `tauri-plugin-apk-installer` 安装

### 🔧 CI/CD 流水线

新增完整的 GitHub Actions CI 流水线，覆盖代码质量和多平台构建：

**CI 检查**：
- `cargo fmt --check`：代码格式检查
- `cargo clippy -D warnings`：静态分析
- `cargo test --workspace`：全 workspace 测试（Ubuntu）
- 跨平台库测试（macOS、Windows）
- `rustsec/audit-check`：依赖安全审计

**Release 流水线**：
- 全平台构建（Windows x64/ARM64、Linux x64/ARM64、macOS Intel/Apple Silicon）
- Android APK 构建 + minisign 签名
- iOS TestFlight 构建

### 🧪 测试覆盖增强

大幅提升测试覆盖率：

**核心库**：
- 新增 `test_utils` 模块（MockAccountRepository、MockCredentialStore、MockDomainMetadataRepository）
- `create_test_context()` 测试工厂方法

**Provider 集成测试**：
- 阿里云、Cloudflare、DNSPod、华为云全覆盖
- 凭证验证、域名列表/详情、记录 CRUD（A/AAAA/CNAME/MX/TXT/SRV/CAA）
- 错误映射单元测试

**工具箱**：
- 域名验证单元测试（13 个用例：IDN、IP 地址、长度限制等）

**Android 更新**：
- 版本比较测试
- 公钥解码测试

## 重大重构

### 📦 Cargo Workspace 统一

将整个项目重构为标准 Cargo Workspace，实现统一的依赖管理和构建流程：

**Workspace 结构**：
```
dns-orchestrator/
├── Cargo.toml                          # Workspace 根配置
├── dns-orchestrator-core/              # 核心业务逻辑库
├── dns-orchestrator-provider/          # DNS 提供商抽象层
├── dns-orchestrator-toolbox/           # 网络诊断工具箱（新独立 crate）
├── dns-orchestrator-web/               # Web 后端
│   └── migration/                      # 数据库迁移
└── dns-orchestrator-tauri/             # Tauri 桌面/移动应用（原 src-tauri）
    └── tauri-plugin-apk-installer/     # APK 安装插件
```

**核心改进**：
- Workspace 级统一依赖版本管理（`[workspace.dependencies]`）
- Workspace 级统一 lint 配置
- `resolver = "2"` 特性解析器
- 统一 `dns-orchestrator-*` 命名风格

### 🧰 工具箱独立 Crate

将工具箱功能从 `dns-orchestrator-core` 拆分为独立的 `dns-orchestrator-toolbox` crate：

**服务模块**：
- WHOIS 查询、DNS 解析、DNS 传播检查
- DNSSEC 验证（重构，添加共享解析器模块）
- IP 地理位置查询、SSL 证书检查、HTTP 头分析

**设计特点**：
- 无状态设计（所有方法为 `ToolboxService` 的 async 关联函数）
- 独立的错误类型（`ToolboxError`、`ToolboxResult`）
- 完整的类型定义（727 行类型文件）

### 🔀 账户服务合并与类型系统重构

将四个分散的账户服务合并为统一的 `account_service`，简化服务架构：

**合并的服务**：
- `account_bootstrap_service` → `account_service`
- `account_lifecycle_service` → `account_service`
- `account_metadata_service` → `account_service`
- `credential_management_service` → `account_service`

**ServiceContext 封装**：
- 字段从 `pub` 改为 `pub(crate)` 私有化
- 添加 getter 方法，遵循封装原则

### 🗑️ Actix-Web 后端移除

移除 `src-actix-web` crate，聚焦 Tauri 桌面/移动端：
- 减少维护负担
- 简化项目结构
- 专注核心用户场景

### 📝 代码注释英文化

重构所有核心库和提供商模块的代码注释为英文：
- `dns-orchestrator-core`
- `dns-orchestrator-provider`
- `dns-orchestrator-web`
- 优化项目结构和模块组织

## 技术改进

### 错误处理增强

- Provider 错误处理与记录解析优化
- 错误处理中默认值显示问题修复
- 完善文档和错误信息国际化

### 依赖优化

- 移除冗余依赖并统一 TLS 特性传递
- 升级 `security-framework` 和 `native-tls` 依赖版本
- 最小 Rust 版本要求：`1.89`

### 代码质量

- 统一代码格式（`rustfmt.toml` 配置）
- 修复 Clippy 警告
- 统一使用格式化字符串（`format!` 宏替代字符串拼接）
- 添加 Clippy 忽略属性和改进测试忽略信息
- 使用 `cast_signed()` 显式方法替代 `as` 类型转换，移除 `#[allow(clippy::cast_possible_wrap)]`

### UI 修复

- 修复按钮可访问性问题
- 添加 Biome 忽略注释

## 技术统计

- **变更文件**：261 个
- **新增代码**：+18,135 行
- **删除代码**：-16,539 行
- **净增加**：+1,596 行

**主要 crate 版本**：
| Crate | 版本 |
|-------|------|
| dns-orchestrator-core | 0.1.0 |
| dns-orchestrator-provider | 0.1.0 |
| dns-orchestrator-toolbox | 0.1.3 |
| 应用版本（package.json） | 1.9.0 |

## 升级说明

从 v1.8.0 升级到 v1.9.0 需注意以下事项：

### 对开发者

1. **项目结构变更**：`src-tauri` 已重命名为 `dns-orchestrator-tauri`
2. **Cargo Workspace**：现在使用 `cargo build --workspace` 构建整个项目
3. **Rust 版本要求**：最低 Rust 1.89
4. **ServiceContext API 变更**：字段已私有化，需使用 getter 方法访问

### 对用户

1. **功能兼容**：所有现有功能保持不变
2. **数据兼容**：无需数据迁移
3. **Android 用户**：更新下载现增加签名验证，更安全

**破坏性变更**（仅影响开发者/外部调用者）：
- `ServiceContext` 字段私有化，需通过 getter 访问
- 四个账户服务合并为 `account_service`
- 工具箱 API 路径变更（从 core 迁移到独立 crate）
- `src-actix-web` 已移除

## 已知问题

- 工具箱功能拆分后，部分 API 路径可能需要适配
- CI 流水线中 Provider 集成测试需要真实凭证（环境变量配置），默认跳过

## 致谢

感谢 @AptS-1547 和 @AptS-1548 的贡献。

## 下一步计划

- 域名元数据导入/导出（JSON/CSV）
- 更多网络诊断工具
- 标签筛选增强（"与"逻辑支持）
- Web 后端功能完善

---

**完整变更日志**：[v1.8.0...v1.9.0](https://github.com/AptS-1547/dns-orchestrator/compare/v1.8.0...v1.9.0)
